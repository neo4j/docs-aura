[aura-customer-metrics-process]
= Metrics integration process
:description: This page describes the metrics integration process for Neo4j Aura.
:page-aliases: platform/metrics-integration.adoc#aura-cmi-steps
:table-caption!:

label:AuraDB-Virtual-Dedicated-Cloud[]
label:AuraDS-Enterprise[]
label:AuraDB-Business-Critical[]

Metrics integration is a two-step process:

- Aura CMI setup
- Customer APM integration

[aura-cmi-setup]
== Aura CMI setup

. Log in to Aura as project admin.
. Make sure there is a dedicated Aura user to use for fetching metrics.
You can either:
 ** Create a new user:
  ... Invite a new user, selecting _Metrics Reader_ as a role in `Project > Users`.
  ... Follow the invitation link and log in to Neo4j Aura.
  ... Confirm the project membership.
 ** Or you can find an existing user in `Project > Users` and change its role to _Metrics Reader_
. Ensure you are logged in to Aura as the user selected in the previous step.
In `Account > API Keys`, create new Aura API credentials.
Save client secret.

[NOTE]
====
Capabilities of users with the role _Metrics Reader_ are limited to fetching the metrics and getting a read-only view of the project.
====

[aura-cmi-apm-integration]
== Customer APM integration

. Optionally configure interested endpoints as described in <<cmi-endpoint-config, Metrics endpoint configuration>> before setting up the APM system.
. To set up an APM system to fetch Aura metrics, click on the `...` in the table view and copy either the endpoint URL or Prometheus job configuration template (if configuring Prometheus).
+
image::cmi_apm_config_input.png[]
+
. Use oauth2 type of authentication specifying the Client ID and Client Secret created in the previous step. See examples for **__Prometheus__** and **__Datadog__** xref:./examples.adoc[here].
. Once metrics start flowing to APM system, statuses of used endpoints can be viewed in the Metrics integration table. __(See the section about Metrics endpoint configuration below for an example of the status table)__

[[cmi-endpoint-config]]
== Metrics endpoint configuration

[NOTE]
====
To change the metrics endpoint configuration, you need to have the _Project Admin_ role in the project.
====

Aura Metrics Integration setup offers two types of metrics endpoints to endpoint Aura instance metrics:

- **Project metrics endpoint** - A single endpoint with Project level endpoint configuration that allows selecting which instance metrics to include.
- **Instance metrics endpoint** - Individual endpoint for each of the instances in the Project with corresponding endpoint configuration.

image::cmi_status_table.png[]

Use the __Settings__ button for an endpoint in the table to configure that endpoint.

[NOTE]
====
**_Selecting endpoints_**

Selecting an endpoint is based on individual use cases.

In general, if there is a need to monitor the performance of a specific Aura instance in your project it's better to use the instance endpoint.

If your goal is to monitor a subset of instances in the Project and you don't want to configure an APM system for each endpoint, then configure the Project endpoint and select the instances you are interested in.
====

* Project endpoint configuration:
+
image::cmi_project_config.png[]
+
. `Selecting instances to include in project endpoint` - This is a project endpoint specific setting which allows users to select instances this endpoint should report metrics for.
+
[IMPORTANT]
====
Selecting only the relevant instances helps to improve the latency of the metrics endpoint and reduces the amount of data sent to the APM system.
====
. `Include new instances` - This setting enables scraping for newly created instance without manually updating the Project endpoint configuration.
. `Metrics granularity` - This setting allows scraping more granular metrics (`Comprehensive`) for the instance(s) of this endpoint.
This currently includes grouping by availability zone and exposing instance type (primary/secondary).

* Instance endpoint configuration allows configuring the `Metrics granularity` for the corresponding instance.
+
image::cmi_instance_config.png[]

[IMPORTANT]
====
Endpoint configuration changes affect the metrics endpoints only after **__5 minutes__** of submitting these changes from UI due to Metrics integration service caching.
====
